<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mars Invaders</title>
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;overflow:hidden;height:100vh;width:100vw}
    canvas{position:absolute;border:2px solid #fff;background:url('news.jpg') center/cover no-repeat}
    #gameOver{position:absolute;color:#ff4444;font-size:clamp(30px,8vw,50px);text-align:center;
              left:50%;top:50%;transform:translate(-50%,-50%);z-index:10;display:none;
              text-shadow:2px 2px 6px #000;white-space:pre-line}
    #rotate{position:fixed;inset:0;background:#000;color:#fff;display:none;
            flex-direction:column;justify-content:center;align-items:center;z-index:100;
            font-size:clamp(24px,6vw,36px)}
    #rotate .icon{font-size:80px;animation:s 2s linear infinite}
    @keyframes s{to{transform:rotate(360deg)}}
    #controls{position:absolute;bottom:0;left:0;right:0;height:200px;display:none;z-index:20;pointer-events:none}
    #joy{position:absolute;left:30px;bottom:30px;width:140px;height:140px;
         background:rgba(255,255,255,0.15);border:4px solid rgba(255,255,255,0.4);
         border-radius:50%;pointer-events:auto}
    #joy::before{content:'';position:absolute;top:50%;left:50%;width:60px;height:60px;
                 background:rgba(255,255,255,0.6);border-radius:50%;transform:translate(-50%,-50%)}
    #joy.active::before{background:#0f0;box-shadow:0 0 20px #0f0}
    #fire{position:absolute;right:40px;bottom:40px;width:110px;height:110px;
          background:rgba(255,0,0,0.35);border:5px solid rgba(255,100,100,0.9);
          border-radius:50%;pointer-events:auto;color:white;font:bold 18px Arial;
          text-align:center;line-height:110px;text-shadow:2px 2px 4px #000}
    #fire:active{background:rgba(255,50,50,0.7)}
    audio{display:none}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="gameOver">GAME OVER<br>Tap to Restart</div>
<div id="rotate"><h1>Rotate to Landscape</h1><div class="icon">Rotate</div></div>

<div id="controls">
    <div id="joy"></div>
    <div id="fire">FIRE</div>
</div>

<audio id="bg" loop preload="auto"><source src="entertainer.mp3" type="audio/mpeg"></audio>
<audio id="shot" preload="auto"><source src="shot.mp3" type="audio/mpeg"></audio>

<script>
const canvas=document.getElementById('c'), ctx=canvas.getContext('2d');
const W=800, H=600;
const gameOverDiv=document.getElementById('gameOver');
const rotateDiv=document.getElementById('rotate');
const controlsDiv=document.getElementById('controls');
const joy=document.getElementById('joy');
const fire=document.getElementById('fire');
const bg=document.getElementById('bg');
const shot=document.getElementById('shot');

const playerImg=new Image(); playerImg.src='https://mars-alien.com/game/paddle1.png';
const mainImg=new Image(); mainImg.src='https://mars-alien.com/game/mainbase.png';
const glowImg=new Image(); glowImg.src='https://mars-alien.com/game/glowtube.png';

const isMobile=/Mobi|Android|iPhone|iPad|iPod/.test(navigator.userAgent);
let portrait=true, unlocked=false, joyActive=false, joyId=null, joyDelta=0, firing=false;

// Unlock audio
function unlock(){if(!unlocked){unlocked=true;bg.play().catch(()=>{});shot.play().catch(()=>{});shot.pause();}}

// Joystick
joy.addEventListener('pointerdown',e=>{unlock();if(joyId)return;joyId=e.pointerId;joyActive=true;joy.classList.add('active');moveJoy(e);});
function moveJoy(e){
    const r=joy.getBoundingClientRect();
    const dx=e.clientX-(r.left+70);
    const d=Math.min(70,Math.abs(dx))*Math.sign(dx);
    joyDelta=d; joy.style.setProperty('--dx',d+'px');
}
document.addEventListener('pointermove',e=>{if(e.pointerId===joyId)moveJoy(e);});
document.addEventListener('pointerup',e=>{if(e.pointerId===joyId){joyId=null;joyActive=false;joyDelta=0;joy.classList.remove('active');joy.style.removeProperty('--dx');}});

// Fire
fire.addEventListener('pointerdown',e=>{e.preventDefault();unlock();firing=true;});
fire.addEventListener('pointerup',()=>{firing=false;});
fire.addEventListener('pointercancel',()=>{firing=false;});

// Restart
document.addEventListener('pointerdown',()=>{if(gameOver)resetGame();});

// Keyboard
const keys={};
document.addEventListener('keydown',e=>{unlock();keys[e.code]=true;if(gameOver&&e.code==='KeyR')resetGame();});
document.addEventListener('keyup',e=>keys[e.code]=false);

// Resize
function resize(){
    const dpr=Math.min(window.devicePixelRatio||1,2);
    const scale=Math.min(innerWidth/W,innerHeight/H);
    const w=W*scale, h=H*scale;
    canvas.style.width=w+'px';canvas.style.height=h+'px';
    canvas.style.left=(innerWidth-w)/2+'px';canvas.style.top=(innerHeight-h)/2+'px';
    canvas.width=W*dpr;canvas.height=H*dpr;ctx.setTransform(dpr,0,0,dpr,0,0);
    portrait=innerHeight>innerWidth;
    rotateDiv.style.display=portrait?'flex':'none';
    controlsDiv.style.display=(isMobile&&!portrait)?'block':'none';
}
window.addEventListener('resize',resize);
window.addEventListener('orientationchange',()=>setTimeout(resize,300));

// Game variables
let player, aliens=[], pBullets=[], aBullets=[], powerups=[];
let score=0, lives=3, dir=1, down=false, gameOver=false, trans=false, alienSpeed=1, lastShot=0;

function initPlayer(){player={x:W/2-60,y:H-120,w:120,h:120,vw:73,vh:32,speed:6,shield:false,shieldEnd:0};}
function initAliens(){
    aliens=[];for(let r=0;r<5;r++)for(let c=0;c<9;c++){
        const g=Math.random()>0.5;
        aliens.push({x:c*64+50,y:r*54+30,w:54,h:27,alive:true,sprite:g?glowImg:mainImg,hits:g?2:1});
    }
}
function resetGame(){
    initPlayer();initAliens();pBullets=[];aBullets=[];powerups=[];
    score=0;lives=3;dir=1;down=false;gameOver=false;trans=false;alienSpeed=1;lastShot=0;
    gameOverDiv.style.display='none';
    requestAnimationFrame(loop);
}
function playShot(){const s=shot.cloneNode();s.volume=0.5;s.play().catch(()=>{});}

// Game loop functions
function updatePlayer(){
    if(joyActive) player.x=Math.max(0,Math.min(W-120,W/2-60+joyDelta*6));
    else{if(keys['ArrowLeft'])player.x-=player.speed;if(keys['ArrowRight'])player.x+=player.speed;}
    player.x=Math.max(0,Math.min(W-120,player.x));
    const now=Date.now();
    if((firing||keys['Space'])&&now-lastShot>110){
        pBullets.push({x:player.x+60-2.5,y:player.y,w:5,h:10});playShot();lastShot=now;
    }
}
function updateAliens(){
    if(trans)return;
    let minX=Infinity,maxX=0;
    aliens.forEach(a=>{if(a.alive){minX=Math.min(minX,a.x);maxX=Math.max(maxX,a.x+a.w);}});
    if(maxX>W-10||minX<10){dir*=-1;down=true;}
    aliens.forEach(a=>{if(a.alive){
        a.x+=alienSpeed*dir;if(down)a.y+=10;
        if(Math.random()<0.001&&aBullets.length<3)
            aBullets.push({x:a.x+a.w/2-2.5,y:a.y+a.h,w:5,h:10});
    }});down=false;
}
function updateBullets(){
    pBullets=pBullets.filter(b=>b.y>0);pBullets.forEach(b=>b.y-=5);
    aBullets=aBullets.filter(b=>b.y<H);aBullets.forEach(b=>b.y+=5);
}
function updatePowerups(){powerups=powerups.filter(p=>p.y<H);powerups.forEach(p=>p.y+=1.5);}
function updateShield(){if(player.shield&&Date.now()>player.shieldEnd)player.shield=false;}
function checkCollisions(){
    // power-ups
    for(let i=powerups.length-1;i>=0;i--){
        const p=powerups[i];
        if(p.x<player.x+120&&p.x+25>player.x&&p.y<player.y+120&&p.y+12>player.y){
            player.shield=true;player.shieldEnd=Date.now()+10000;powerups.splice(i,1);
        }
    }
    // alien bullets
    aBullets.forEach(b=>{
        if(b.x<player.x+23+73&&b.x+5>player.x+23&&b.y<player.y+44+32&&b.y+10>player.y+44){
            if(!player.shield){lives--;if(lives<=0){gameOver=true;gameOverDiv.style.display='block';}}
            b.y=H+10;
        }
    });
    // player bullets
    pBullets.forEach(b=>{
        aliens.forEach(a=>{
            if(a.alive&&b.x<a.x+a.w&&b.x+5>a.x&&b.y<a.y+a.h&&b.y+10>a.y){
                a.hits--;b.y=-10;
                if(a.hits<=0){
                    a.alive=false;score+=a.sprite===glowImg?20:10;
                    if(Math.random()<0.15)powerups.push({x:a.x+a.w/2-12.5,y:a.y,w:25,h:12});
                }
            }
        });
    });
    aliens.forEach(a=>{if(a.alive&&a.y+a.h>player.y){gameOver=true;gameOverDiv.style.display='block';}});
}
function nextLevel(){trans=true;aBullets=[];pBullets=[];powerups=[];
    setTimeout(()=>{initAliens();alienSpeed*=1.5;trans=false;},500);}

// Draw functions
function drawPlayer(){if(playerImg.complete)ctx.drawImage(playerImg,player.x,player.y,120,120);}
function drawAliens(){aliens.forEach(a=>{if(a.alive&&a.sprite&&a.sprite.complete)ctx.drawImage(a.sprite,a.x,a.y,a.w,a.h);});}
function drawBullets(){ctx.fillStyle='#0f0';pBullets.forEach(b=>ctx.fillRect(b.x,b.y,5,10));
                      ctx.fillStyle='#f00';aBullets.forEach(b=>ctx.fillRect(b.x,b.y,5,10));}
function drawPowerups(){ctx.fillStyle='rgba(0,255,255,0.8)';powerups.forEach(p=>ctx.fillRect(p.x,p.y,25,12));}
function drawShield(){if(player.shield){ctx.fillStyle='#0ff';ctx.font='bold 20px Arial';ctx.textAlign='center';
                      ctx.fillText('----------',player.x+60,player.y-15);ctx.textAlign='left';}}
function drawUI(){ctx.fillStyle='#fff';ctx.font='20px Arial';
                  ctx.fillText('Score: '+score,10,25);ctx.fillText('Lives: '+lives,W-110,25);}

function loop(){
    if(portrait||gameOver)return;
    ctx.clearRect(0,0,W,H);
    updatePlayer();updateAliens();updateBullets();updatePowerups();updateShield();checkCollisions();
    drawPlayer();drawShield();drawAliens();drawBullets();drawPowerups();drawUI();
    if(aliens.every(a=>!a.alive)&&!trans)nextLevel();
    requestAnimationFrame(loop);
}

// Start when images are ready
let loaded=0;
function imgOk(){if(++loaded===3){resize();resetGame();}}
playerImg.onload=mainImg.onload=glowImg.onload=imgOk;
playerImg.onerror=mainImg.onerror=glowImg.onerror=imgOk;

resize();
</script>
</body>
</html>